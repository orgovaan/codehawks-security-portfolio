# First Flight #7: Horse Store - Findings Report

# Table of contents
- ## [Contest Summary](#contest-summary)
- ## [Results Summary](#results-summary)
- ## High Risk Findings
    - ### [H-01. Missing checks for existance of specific `horseId` in functions `HorseStore::feedhorse` and `HorseStore::isHappyHorse`](#H-01)

- ## Low Risk Findings
    - ### [L-01. Arbitrum does not yet support `PUSH0` opcodes used by Solc compiler version 0.8.20, deployment to Arbitrum will fail](#L-01)
    - ### [L-02. Redundant import of the `ERC721` contract](#L-02)
    - ### [L-03. Missing `horseFed` event emission in the `HorseStore::feedHorse` method ](#L-03)


# <a id='contest-summary'></a>Contest Summary

### Sponsor: First Flight #7

### Dates: Jan 11th, 2024 - Jan 18th, 2024

[See more contest details here](https://www.codehawks.com/contests/clr6s75ut00013qg9z8bpkalo)

# <a id='results-summary'></a>Results Summary

### Number of findings:
   - High: 1
   - Medium: 0
   - Low: 3


# High Risk Findings

## <a id='H-01'></a>H-01. Missing checks for existance of specific `horseId` in functions `HorseStore::feedhorse` and `HorseStore::isHappyHorse`            

### Relevant GitHub Links
	
https://github.com/Cyfrin/2024-01-horse-store/blob/01bce4f0a2271c4105ee7c9121b27fe7973b0eaf/src/HorseStore.sol#L32C1-L34C6

https://github.com/Cyfrin/2024-01-horse-store/blob/01bce4f0a2271c4105ee7c9121b27fe7973b0eaf/src/HorseStore.sol#L41C1-L46C6

## Summary
In functions `HorseStore::feedhorse` and `HorseStore::isHappyHorse`, it is not checked whether the `horseId` provided to these functions as an input parameter actually exists (i.e. whether a horse with that `horseId` has been minted yet or not).
## Vulnerability Details
Consider the following series of steps:
1. `horseId=X` does not exist yet, but the `HorseStore::feedhorse` is called on it,
2. Horse with `horseId=X` is minted immediately after step 1.
3. Happyness of `horseId=X` is queired with HorseStore::isHappyHorse`, and the query will return `true` even though the horse has never been actually fed.

```javascript
    function test_neverFedHorseAppearsHappy() public {
        uint256 horseId = horseStore.totalSupply();
        console2.log(horseStore.isHappyHorse(horseId));
        horseStore.feedHorse(horseId);
        console2.log(horseStore.isHappyHorse(horseId));
        vm.prank(user);
        horseStore.mintHorse();
        console2.log(horseStore.isHappyHorse(horseId));
    }
```
## Impact
The information about fed status provided by the protocol becomes unreliable.

## Tools Used
Manual review.
## Recommendations
Implement a check in the very beginning of both the HorseStore::feedhorse` and the `HorseStore::isHappyHorse` functions.
```javascript
require(horseId < totalSupply());
```


		


# Low Risk Findings

## <a id='L-01'></a>L-01. Arbitrum does not yet support `PUSH0` opcodes used by Solc compiler version 0.8.20, deployment to Arbitrum will fail            

### Relevant GitHub Links
	
https://github.com/Cyfrin/2024-01-horse-store/blob/01bce4f0a2271c4105ee7c9121b27fe7973b0eaf/src/HorseStore.sol#L2

## Summary
Solc compiler version 0.8.20 switches the default target EVM version to Shanghai, which means that the generated bytecode will include `PUSH0` opcodes. Arbitrum does not yet support PUSH0 and, hence, deployment to Arbitrum will fail.
## Vulnerability Details
-
## Impact
Deployment to Arbitrum will fail.
## Tools Used
Aderyn
## Recommendations
Either 
- use solc compiler version 0.8.19 (or earlier), or
- wait for Arbitrum to add support for the EVM Shanghai upgrade and the `PUSH0` opcode. The [proposal](https://forum.arbitrum.foundation/t/aip-arbos-version-11/19696/11) to add such a support has recently passed, and the changes are expected to take effect on 2024-01-27.
## <a id='L-02'></a>L-02. Redundant import of the `ERC721` contract            

### Relevant GitHub Links
	
https://github.com/Cyfrin/2024-01-horse-store/blob/01bce4f0a2271c4105ee7c9121b27fe7973b0eaf/src/HorseStore.sol#L4

## Summary
`ERC721Enumerable` is an extension of `ERC721` and inherits all of its functionality, so importing `ERC721` next to an imported `ERC721Enumerable` is redundant.
## Vulnerability Details
-
## Impact
Worsens clarity, code size and efficiency.
## Tools Used
Manual review.
## Recommendations
Import only the `ERC721Enumerable` contract, do not import `ERC721` with it. 
## <a id='L-03'></a>L-03. Missing `horseFed` event emission in the `HorseStore::feedHorse` method             

### Relevant GitHub Links
	
https://github.com/Cyfrin/2024-01-horse-store/blob/01bce4f0a2271c4105ee7c9121b27fe7973b0eaf/src/HorseStore.sol#L34C1-L34C1

## Summary
Events for critical state changes (like a horse having been fed) should be emitted for off-chain tracking.
## Tools Used
Manual review.
## Recommendations
Add a `HorseFed` event that takes the `horseId` as a parameter, and emit this event at the end of the `HorseStore::feedHorse` method.




